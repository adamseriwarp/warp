name: Generate Carrier Performance Report

on:
  workflow_dispatch:
    inputs:
      carrier_name:
        description: 'Carrier Name (not case-sensitive, e.g., "illyrian transport llc" or "ILLYRIAN TRANSPORT LLC")'
        required: true
        type: string
      email_recipient:
        description: 'Email recipient (optional - leave blank to skip email)'
        required: false
        type: string
        default: ''

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas mysql-connector-python matplotlib resend
      
      - name: Generate carrier report
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          CARRIER_NAME: ${{ github.event.inputs.carrier_name }}
          EMAIL_RECIPIENT: ${{ github.event.inputs.email_recipient }}
        run: |
          python query_otp_clean.py
      
      - name: Upload PDF report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: carrier-report-${{ github.event.inputs.carrier_name }}-${{ github.run_number }}
          path: '*.pdf'
          retention-days: 30
      
      - name: Upload CSV data as artifact
        uses: actions/upload-artifact@v4
        with:
          name: carrier-data-${{ github.event.inputs.carrier_name }}-${{ github.run_number }}
          path: 'otp_data.csv'
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Report generation summary
        run: |
          echo "âœ… Report generated successfully!"
          echo "ðŸ“„ Carrier: ${{ github.event.inputs.carrier_name }}"
          echo "ðŸ“¥ Download the PDF from the 'Artifacts' section below"
          if [ -n "${{ github.event.inputs.email_recipient }}" ]; then
            echo "ðŸ“§ Email sent to: ${{ github.event.inputs.email_recipient }}"
          fi

